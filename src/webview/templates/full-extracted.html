<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haka Insight</title>
    <style>
        :root {
            --tab-active-bg: #0099cc;
            --tab-inactive-bg: rgba(10, 14, 39, 0.5);
            --tab-border: #1a3a52;
            --button-primary: #0099cc;
            --button-primary-hover: #007799;
            --button-secondary: rgba(10, 14, 39, 0.5);
            --button-secondary-hover: #1a3a52;
            --button-border: #1a3a52;
            --button-text: #4a90b8;
            --button-text-hover: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid #1a1a1a;
            background-color: #0a0e27;
            flex-shrink: 0;
            padding: 4px 8px 0 8px;
        }
        .tab-button {
            min-width: 90px;
            max-width: 120px;
            flex: 0 1 auto;
            padding: 5px 12px;
            border: 1px solid #1a3a52 !important;
            background-color: rgba(10, 14, 39, 0.5) !important;
            color: #4a90b8 !important;
            cursor: pointer;
            font-size: 9px;
            font-weight: 600;
            border-radius: 5px;
            margin: 0 2px;
            transition: all 0.3s ease;
            position: relative;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }
        .tab-button:hover:not(.active) {
            border-color: #2a5a82 !important;
            color: #6ab0d8 !important;
            background-color: rgba(26, 58, 82, 0.3) !important;
        }
        .tab-button.active {
            background: #0099cc !important;
            color: #ffffff !important;
            border-color: #0099cc !important;
            box-shadow: 
                0 0 10px rgba(0, 153, 204, 0.4),
                0 0 5px rgba(0, 153, 204, 0.3),
                0 2px 6px rgba(0, 153, 204, 0.2) !important;
        }
        .tab-button.active::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(135deg, #0099cc, #007799);
            border-radius: 5px;
            z-index: -1;
            opacity: 0.2;
            filter: blur(3px);
        }
        .content-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: none;
        }
        .tab-content.active { display: flex; flex-direction: column; }
        .diagram-container { width: 100%; height: 100%; display: flex; flex-direction: column; gap: 16px; }
        .settings-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
        }
        .settings-section {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }
        .settings-section-icon {
            font-size: 18px;
        }
        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #cccccc;
        }
        .settings-section-content {
            padding: 12px;
        }
        .form-group-compact {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .label-compact {
            font-size: 12px;
            font-weight: 500;
            color: #858585;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .input-compact {
            max-width: 400px;
            padding: 5px 8px;
            background-color: #3c3c3c;
            border: 1px solid #555555;
            color: #e0e0e0;
            border-radius: 3px;
            font-size: 12px;
            transition: border-color 0.2s ease;
        }
        .input-compact:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 1px #007acc;
        }
        .input-with-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .input-api-key {
            width: 100%;
            max-width: 400px;
        }
        .button-group-inline {
            display: flex;
            gap: 8px;
        }
        .button-compact {
            padding: 6px 12px;
            border: 1px solid var(--button-border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: var(--button-secondary);
            color: var(--button-text);
        }
        .button-compact .button-icon {
            font-size: 12px;
        }
        .button-compact .button-text {
            font-size: 11px;
        }
        .button-compact:hover {
            background-color: var(--button-primary);
            color: var(--button-text-hover);
            border-color: var(--button-primary);
        }
        .button-primary {
            background-color: var(--button-primary);
            color: var(--button-text-hover);
            border-color: var(--button-primary);
        }
        .button-primary:hover {
            background-color: var(--button-primary-hover);
            border-color: var(--button-primary-hover);
        }
        .button-secondary {
            background-color: var(--button-secondary);
            color: var(--button-text);
            border-color: var(--button-border);
        }
        .button-secondary:hover {
            background-color: var(--button-secondary-hover);
            border-color: var(--button-border);
        }
        .button-test {
            background-color: #2d7d2d;
            color: white;
            border-color: #2d7d2d;
        }
        .button-test:hover {
            background-color: #236623;
            border-color: #236623;
        }
        .button-test:disabled {
            background-color: #3e3e42;
            color: #858585;
            cursor: not-allowed;
        }
        .connection-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 11px;
            display: none;
        }
        .connection-status.visible {
            display: block;
        }
        .connection-status.success {
            background-color: #1e3a1e;
            border: 1px solid #2d7d2d;
            color: #4ec94e;
        }
        .connection-status.error {
            background-color: #3a1e1e;
            border: 1px solid #7d2d2d;
            color: #e94e4e;
        }
        .connection-status.loading {
            background-color: #2d3a4e;
            border: 1px solid #4e6a8a;
            color: #7db8e9;
        }
        .help-text {
            font-size: 11px;
            color: #858585;
            margin-top: 4px;
        }
        .help-text a {
            color: #007acc;
            text-decoration: none;
        }
        .help-text a:hover {
            text-decoration: underline;
        }
        .button-danger {
            background-color: #7d2d2d;
            color: #ffffff;
        }
        .button-danger:hover {
            background-color: #a03838;
        }
        /* Keep old button styles for other parts */
        .button-group { display: flex; gap: 8px; margin-top: 8px; }
        .button-group button:not(.button-compact) {
            flex: 1;
            padding: 8px 16px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .button-group button:not(.button-compact):hover { background-color: #005a9e; }
        .button-group button.secondary:not(.button-compact) {
            background-color: #3e3e42;
            color: #cccccc;
        }
        .button-group button.secondary:not(.button-compact):hover { background-color: #4e4e54; }
        .success-message {
            padding: 12px;
            background-color: #0a3a0a;
            border-left: 3px solid #4ec9b0;
            border-radius: 4px;
            color: #4ec9b0;
            font-size: 13px;
            margin-bottom: 16px;
        }
        .error-message {
            padding: 12px;
            background-color: #3a0a0a;
            border-left: 3px solid #f48771;
            border-radius: 4px;
            color: #f48771;
            font-size: 13px;
            margin-bottom: 16px;
        }
        svg { width: 100%; height: 100%; display: block; }
        #diagram-svg { 
            background-color: #252526; 
            border: 1px solid #3e3e42; 
            border-radius: 4px;
            flex: 1;
            min-height: 300px;
            width: 100%;
        }
        .explanation-container {
            margin-top: 12px;
            padding: 12px;
            background-color: #252526;
            border-radius: 4px;
            border-left: 3px solid #4ec9b0;
            display: none;
        }
        .explanation-container.show { display: block; }
        .explanation-title { font-weight: 500; margin-bottom: 8px; color: #4ec9b0; font-size: 12px; }
        .explanation-text { font-size: 12px; line-height: 1.6; color: #cccccc; }
        .warnings-container {
            margin-top: 12px;
            padding: 12px;
            background-color: #252526;
            border-radius: 4px;
            display: none;
        }
        .warnings-container.show { display: block; }
        .warnings-title { font-weight: 500; margin-bottom: 8px; color: #dcdcaa; font-size: 12px; }
        .warning-item {
            padding: 8px;
            margin-bottom: 6px;
            background-color: #1e1e1e;
            border-left: 3px solid #dcdcaa;
            border-radius: 2px;
            font-size: 11px;
            line-height: 1.4;
        }
        .warning-item.high { border-left-color: #f48771; }
        .warning-item.medium { border-left-color: #dcdcaa; }
        .warning-item.low { border-left-color: #4ec9b0; }
        .node-popup {
            position: fixed;
            background-color: #2d2d30;
            border: 1px solid #007acc;
            border-radius: 4px;
            padding: 12px;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .node-popup.show { display: block; }
        .node-popup-title { font-weight: bold; color: #007acc; margin-bottom: 8px; font-size: 12px; }
        .node-popup-description { color: #cccccc; font-size: 11px; line-height: 1.5; }
        .context-menu {
            position: fixed;
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 4px 0;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
            min-width: 150px;
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            color: #cccccc;
            transition: background-color 0.2s ease;
        }
        .context-menu-item:hover { background-color: #3e3e42; }
        .left-menu {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background-color: #1e1e1e;
            border-right: 1px solid #3e3e42;
            overflow-y: auto;
            z-index: 999;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .left-menu.show { transform: translateX(0); }
        .left-menu-header {
            padding: 16px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .left-menu-title { font-weight: bold; color: #007acc; font-size: 13px; }
        .left-menu-close { cursor: pointer; color: #858585; font-size: 18px; }
        .left-menu-item {
            padding: 12px 16px;
            border-bottom: 1px solid #2d2d30;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .left-menu-item:hover { background-color: #2d2d30; }
        .left-menu-item.active { background-color: #007acc; color: white; }
        .left-menu-item-name { font-size: 12px; color: #cccccc; }
        .left-menu-item.active .left-menu-item-name { color: white; }
        .control-buttons {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: row;
            gap: 8px;
            z-index: 100;
        }
        .control-button {
            width: 36px;
            height: 36px;
            padding: 8px;
            background-color: rgba(10, 14, 39, 0.5);
            border: 1px solid #1a3a52;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .control-button:hover { 
            background-color: #0099cc;
            color: #ffffff;
            border-color: #0099cc;
        }
        .control-button.export-button {
            background-color: rgba(10, 14, 39, 0.5);
            border: 1px solid #1a3a52;
        }
        .control-button.export-button:hover {
            background-color: #0099cc;
            color: #ffffff;
            border-color: #0099cc;
        }
        .export-menu {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 4px 0;
            z-index: 101;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
            min-width: 180px;
        }
        .export-menu.show { display: block; }
        .export-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            color: #cccccc;
            transition: background-color 0.2s ease;
        }
        .export-menu-item:hover { background-color: #3e3e42; }
        .export-menu-item-icon {
            margin-right: 8px;
        }
        .diagram-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .diagram-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            z-index: 100;
        }
        .diagram-loading.visible {
            display: flex;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(0, 153, 204, 0.2);
            border-top-color: #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: #4a90b8;
            font-size: 14px;
            font-weight: 500;
        }
        .analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .analysis-modal.visible {
            display: flex;
        }
        .modal-content {
            background-color: #252526;
            border: 1px solid #0099cc;
            border-radius: 8px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            min-width: 300px;
        }
        .modal-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(0, 153, 204, 0.2);
            border-top-color: #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .modal-content h4 {
            color: #0099cc;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        .modal-content p {
            color: #cccccc;
            font-size: 14px;
            margin: 0;
        }
        .details-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            min-height: 200px;
            max-height: 80%;
            background-color: #252526;
            border-top: 2px solid #007acc;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .details-panel.show {
            transform: translateY(0);
        }
        .details-panel-resizer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            cursor: ns-resize;
            background: transparent;
            z-index: 201;
        }
        .details-panel-resizer:hover {
            background: rgba(0, 122, 204, 0.3);
        }
        .details-panel-resizer::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: #858585;
            border-radius: 2px;
        }
        .details-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #3e3e42;
            background-color: #2d2d30;
            flex-shrink: 0;
        }
        .details-panel-title {
            font-size: 14px;
            font-weight: bold;
            color: #007acc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cache-badge {
            display: inline-block;
            padding: 2px 8px;
            background-color: #4ec9b0;
            color: #1e1e1e;
            font-size: 10px;
            font-weight: 600;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .details-panel-close {
            cursor: pointer;
            color: #858585;
            font-size: 20px;
            padding: 0 8px;
            transition: color 0.2s ease;
        }
        .details-panel-close:hover {
            color: #cccccc;
        }
        .details-panel-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }
        .details-section {
            margin-bottom: 16px;
        }
        .cache-info-section {
            background-color: #1e1e1e;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #3e3e42;
        }
        .cache-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .cache-timestamp {
            font-size: 11px;
            color: #858585;
            flex: 1;
        }
        .update-analysis-btn {
            padding: 6px 12px;
            background-color: #007acc;
            color: #ffffff;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .update-analysis-btn:hover {
            background-color: #005a9e;
        }
        .details-section-title {
            font-size: 12px;
            font-weight: 500;
            color: #4ec9b0;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .details-section-text {
            font-size: 12px;
            line-height: 1.6;
            color: #cccccc;
        }
        .details-section-text h1,
        .details-section-text h2,
        .details-section-text h3 {
            color: #4ec9b0;
            margin: 12px 0 8px 0;
            font-weight: 600;
        }
        .details-section-text h1 { font-size: 16px; }
        .details-section-text h2 { font-size: 14px; }
        .details-section-text h3 { font-size: 13px; }
        .details-section-text strong {
            color: #dcdcaa;
            font-weight: 600;
        }
        .details-section-text em {
            color: #ce9178;
            font-style: italic;
        }
        .details-section-text code {
            background-color: #1e1e1e;
            color: #d7ba7d;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px;
        }
        .details-section-text pre {
            background-color: #1e1e1e;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }
        .details-section-text pre code {
            background: none;
            padding: 0;
        }
        .details-section-text p {
            margin: 8px 0;
        }
        .details-section-text br {
            display: block;
            content: "";
            margin: 4px 0;
        }
        .details-warning-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .details-warning-item {
            padding: 8px 12px;
            background-color: #1e1e1e;
            border-left: 3px solid;
            border-radius: 2px;
            font-size: 11px;
            line-height: 1.4;
        }
        .details-warning-item.high {
            border-left-color: #f48771;
        }
        .details-warning-item.medium {
            border-left-color: #dcdcaa;
        }
        .details-warning-item.low {
            border-left-color: #4ec9b0;
        }
        .details-dependencies-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .details-dependency-tag {
            padding: 4px 8px;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            font-size: 11px;
            color: #cccccc;
        }
        
        /* Security Tab Styles */
        .security-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            width: 100%;
            overflow-y: auto;
        }
        .security-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 8px;
        }
        .empty-state-message {
            font-size: 13px;
            color: #858585;
        }
        .security-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }
        .security-summary {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .summary-header h3 {
            margin: 0;
            font-size: 14px;
            color: #cccccc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .report-button {
            padding: 6px 12px;
            border: 1px solid #1a3a52;
            background-color: rgba(10, 14, 39, 0.5);
            color: #4a90b8;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .report-button:hover {
            background-color: #0099cc;
            color: #ffffff;
            border-color: #0099cc;
        }
        .report-button .button-icon {
            font-size: 12px;
        }
        .report-button .button-text {
            font-size: 11px;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat-card {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 12px;
            text-align: center;
        }
        .stat-card.stat-high {
            border-left: 3px solid #f48771;
        }
        .stat-card.stat-medium {
            border-left: 3px solid #dcdcaa;
        }
        .stat-card.stat-low {
            border-left: 3px solid #4ec9b0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 10px;
            color: #858585;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .risk-level-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px;
            background-color: #1e1e1e;
            border-radius: 4px;
        }
        .risk-level-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .risk-level-label {
            font-size: 12px;
            color: #cccccc;
            font-weight: 500;
        }
        .risk-level-badge {
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .risk-level-badge.critical {
            background-color: #5a1e1e;
            color: #f48771;
            border: 1px solid #f48771;
        }
        .risk-level-badge.high {
            background-color: #5a3a1e;
            color: #dcdcaa;
            border: 1px solid #dcdcaa;
        }
        .risk-level-badge.medium {
            background-color: #1e3a5a;
            color: #4ec9b0;
            border: 1px solid #4ec9b0;
        }
        .risk-level-badge.low {
            background-color: #1e5a1e;
            color: #4ec94e;
            border: 1px solid #4ec94e;
        }
        .risk-info-button {
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            flex-shrink: 0;
            border-radius: 50%;
            background-color: rgba(125, 184, 233, 0.2);
            color: #7db8e9;
            border: 1px solid #7db8e9;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            margin-left: auto;
        }
        .risk-info-button:hover {
            background-color: #0099cc;
            color: #ffffff;
            border-color: #0099cc;
            transform: scale(1.15);
        }
        .risk-info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .risk-info-modal.show {
            display: flex;
        }
        .risk-info-content {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .risk-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #3e3e42;
        }
        .risk-info-header h4 {
            margin: 0;
            font-size: 15px;
            color: #7db8e9;
        }
        .risk-info-close {
            background: none;
            border: none;
            color: #858585;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .risk-info-close:hover {
            background-color: #3e3e42;
            color: #ffffff;
        }
        .risk-info-body {
            padding: 20px;
            color: #cccccc;
            font-size: 12px;
            line-height: 1.6;
        }
        .risk-info-body p {
            margin: 0 0 16px 0;
        }
        .risk-formula {
            background-color: rgba(10, 14, 39, 0.3);
            border: 1px solid #1a3a52;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }
        .risk-formula-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        .severity-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
        }
        .severity-badge.high {
            background-color: #5a1e1e;
            color: #f48771;
            border: 1px solid #f48771;
        }
        .severity-badge.medium {
            background-color: #5a3a1e;
            color: #dcdcaa;
            border: 1px solid #dcdcaa;
        }
        .severity-badge.low {
            background-color: #1e5a1e;
            color: #4ec94e;
            border: 1px solid #4ec94e;
        }
        .formula-text {
            color: #7db8e9;
            font-family: 'Courier New', monospace;
        }
        .risk-levels {
            margin-top: 16px;
        }
        .risk-level-item {
            padding: 10px 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid;
        }
        .risk-level-item.critical {
            background-color: rgba(90, 30, 30, 0.2);
            border-left-color: #f48771;
        }
        .risk-level-item.high {
            background-color: rgba(90, 58, 30, 0.2);
            border-left-color: #dcdcaa;
        }
        .risk-level-item.medium {
            background-color: rgba(30, 58, 90, 0.2);
            border-left-color: #4ec9b0;
        }
        .risk-level-item.low {
            background-color: rgba(30, 90, 30, 0.2);
            border-left-color: #4ec94e;
        }
        .risk-level-item strong {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
        }
        .risk-level-item p {
            margin: 0;
            font-size: 11px;
            color: #cccccc;
        }
        .ai-report-section {
            margin-top: 16px;
            padding: 16px;
            background-color: rgba(10, 14, 39, 0.3);
            border-radius: 6px;
            border: 1px solid #1a3a52;
        }
        .ai-report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(26, 58, 82, 0.5);
        }
        .ai-report-header h4 {
            margin: 0;
            font-size: 13px;
            color: #7db8e9;
            font-weight: 600;
        }
        .button-regenerate {
            padding: 6px 12px;
            background-color: var(--button-secondary);
            color: var(--button-text);
            border: 1px solid var(--button-border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .button-regenerate:hover {
            background-color: var(--button-primary);
            color: var(--button-text-hover);
            border-color: var(--button-primary);
        }
        .button-regenerate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-regenerate .button-icon {
            font-size: 11px;
        }
        .ai-report-content {
            position: relative;
            min-height: 60px;
        }
        .ai-report-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            gap: 12px;
        }
        .loading-spinner {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(26, 58, 82, 0.3);
            border-top-color: #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 11px;
            color: #7db8e9;
        }
        .ai-report-text {
            font-size: 12px;
            line-height: 1.7;
            color: #cccccc;
            white-space: pre-wrap;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .security-findings {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
        }
        .findings-header h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #cccccc;
        }
        #findings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .findings-file-header {
            margin-top: 16px;
            margin-bottom: 0;
            padding: 14px 16px;
            background-color: transparent;
            border: 2px solid #0099cc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .findings-file-header:hover {
            background-color: rgba(0, 153, 204, 0.1);
            border-color: #00b8e6;
        }
        .findings-file-header.collapsed {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        .findings-file-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #0099cc;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        .accordion-icon {
            font-size: 14px;
            color: #0099cc;
            transition: transform 0.2s ease;
            display: inline-block;
            transform: rotate(90deg);
        }
        .findings-file-header.collapsed .accordion-icon {
            transform: rotate(0deg);
        }
        .findings-file-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 12px;
        }
        .findings-file-content.collapsed {
            max-height: 0;
            margin-top: 0;
        }
        .findings-type-header {
            margin-top: 10px;
            margin-bottom: 6px;
            padding-left: 8px;
            border-left: 3px solid #4a90b8;
        }
        .findings-type-header h5 {
            margin: 0;
            font-size: 11px;
            font-weight: 500;
            color: #4a90b8;
        }
        .finding-item {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-left: 3px solid #858585;
            border-radius: 4px;
            padding: 10px;
            margin-left: 12px;
        }
        .finding-item.high {
            border-left-color: #f48771;
        }
        .finding-item.medium {
            border-left-color: #dcdcaa;
        }
        .finding-item.low {
            border-left-color: #4ec9b0;
        }
        .finding-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .finding-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .finding-type-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .finding-type-badge.security {
            background-color: #5a1e1e;
            color: #f48771;
        }
        .finding-type-badge.logic {
            background-color: #5a3a1e;
            color: #dcdcaa;
        }
        .finding-type-badge.bestPractice {
            background-color: #1e3a5a;
            color: #4ec9b0;
        }
        .finding-severity {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .finding-severity.high {
            background-color: #5a1e1e;
            color: #f48771;
        }
        .finding-severity.medium {
            background-color: #5a3a1e;
            color: #dcdcaa;
        }
        .finding-severity.low {
            background-color: #1e5a1e;
            color: #4ec94e;
        }
        .finding-message {
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 4px;
        }
        .finding-file {
            font-size: 11px;
            color: #7db8e9;
            background-color: rgba(125, 184, 233, 0.1);
            padding: 4px 8px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 6px;
            margin-bottom: 6px;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(125, 184, 233, 0.2);
        }
        .finding-file::before {
            content: 'ðŸ“„ ';
            margin-right: 4px;
        }
        .finding-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        .button-recommendation {
            padding: 6px 12px;
            background-color: var(--button-secondary);
            color: var(--button-text);
            border: 1px solid var(--button-border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            width: auto;
            white-space: nowrap;
        }
        .button-recommendation:hover {
            background-color: var(--button-primary);
            color: var(--button-text-hover);
            border-color: var(--button-primary);
        }
        .button-recommendation:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .navigate-to-code-btn {
            padding: 6px 12px;
            background-color: var(--button-secondary);
            color: var(--button-text);
            border: 1px solid var(--button-border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            width: auto;
            white-space: nowrap;
        }
        .navigate-to-code-btn:hover {
            background-color: var(--button-primary);
            color: var(--button-text-hover);
            border-color: var(--button-primary);
        }
        .recommendation-panel {
            margin-top: 8px;
            padding: 12px;
            background-color: #252526;
            border: 1px solid #4e6a8a;
            border-radius: 4px;
            display: none;
        }
        .recommendation-panel.visible {
            display: block;
        }
        .recommendation-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #858585;
            font-size: 11px;
        }
        .recommendation-loading .loading-spinner {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }
        .recommendation-text {
            font-size: 11px;
            line-height: 1.6;
            color: #cccccc;
            white-space: pre-wrap;
        }

        /* Quality Tab Styles */
        .quality-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            width: 100%;
            overflow-y: auto;
        }
        .quality-header {
            margin-bottom: 24px;
        }
        .quality-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .quality-header h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #cccccc;
        }
        .quality-description {
            margin: 0;
            font-size: 13px;
            color: #858585;
        }
        .quality-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }
        .quality-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }
        .quality-summary {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
        }
        .quality-findings {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 16px;
        }
        .quality-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card.stat-info {
            border-left: 3px solid #4ec9b0;
        }
        .stat-card.stat-warning {
            border-left: 3px solid #dcdcaa;
        }
        .quality-actions {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }
        .quality-sections {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .quality-section {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 20px;
        }
        .quality-section h4 {
            margin: 0 0 16px 0;
            font-size: 14px;
            color: #cccccc;
            font-weight: 600;
        }
        .quality-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .quality-item {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .quality-item-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .quality-item-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .quality-item-severity.critical {
            background-color: #5a1e1e;
            color: #f48771;
        }
        .quality-item-severity.high {
            background-color: #5a3a1e;
            color: #dcdcaa;
        }
        .quality-item-severity.medium {
            background-color: #1e3a5a;
            color: #4ec9b0;
        }
        .quality-item-severity.low {
            background-color: #1e5a1e;
            color: #4ec94e;
        }
        .quality-item-title {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: #cccccc;
        }
        .quality-item-description {
            font-size: 12px;
            color: #858585;
            line-height: 1.5;
        }
        .quality-item-file {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background-color: rgba(30, 58, 90, 0.3);
            border-radius: 3px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #7db8e9;
        }
        .quality-item-suggestion {
            margin-top: 8px;
            padding: 12px;
            background-color: rgba(78, 201, 176, 0.1);
            border-left: 3px solid #4ec9b0;
            border-radius: 4px;
        }
        .quality-item-suggestion-title {
            font-size: 11px;
            font-weight: 600;
            color: #4ec9b0;
            margin-bottom: 4px;
        }
        .quality-item-suggestion-text {
            font-size: 12px;
            color: #cccccc;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="left-menu" id="left-menu">
        <div class="left-menu-header">
            <div class="left-menu-title">Analyzed Files</div>
            <div class="left-menu-close" id="left-menu-close">âœ•</div>
        </div>
        <div id="analyzed-files-list"></div>
    </div>

    <div class="tab-container">
        <button class="tab-button active" data-tab="diagram">Diagrama</button>
        <button class="tab-button" data-tab="security">Seguridad</button>
        <button class="tab-button" data-tab="quality">Calidad</button>
        <button class="tab-button" data-tab="settings">Config</button>
    </div>

    <div class="content-wrapper">
        <div class="tab-content active" id="diagram-tab">
            <div class="diagram-container">
                <div class="diagram-wrapper">
                    <svg id="diagram-svg"></svg>
                    
                    <!-- Diagram Loading Indicator -->
                    <div class="diagram-loading" id="diagram-loading">
                        <div class="loading-spinner"></div>
                        <p class="loading-text" data-i18n="loadingDiagram">Loading diagram...</p>
                    </div>
                    
                    <!-- Unified control buttons in bottom-left corner -->
                    <div class="control-buttons">
                        <button class="control-button menu-button" id="menu-button" title="Menu">â˜°</button>
                        <button class="control-button export-button" id="export-button" title="Export">ðŸ“¤</button>
                        <button class="control-button" id="zoom-in-button" title="Zoom In">+</button>
                        <button class="control-button" id="zoom-out-button" title="Zoom Out">âˆ’</button>
                        <button class="control-button" id="reset-zoom-button" title="Reset">âŸ²</button>
                    </div>
                    
                    <!-- Export menu -->
                    <div class="export-menu" id="export-menu">
                        <div class="export-menu-item" data-format="png">
                            <span class="export-menu-item-icon">ðŸ–¼ï¸</span>Export as PNG
                        </div>
                        <div class="export-menu-item" data-format="svg">
                            <span class="export-menu-item-icon">ðŸ“</span>Export as SVG
                        </div>
                        <div class="export-menu-item" data-format="mermaid">
                            <span class="export-menu-item-icon">ðŸ“Š</span>Export as Mermaid
                        </div>
                        <div class="export-menu-item" data-format="json">
                            <span class="export-menu-item-icon">ðŸ“„</span>Export as JSON
                        </div>
                    </div>
                </div>
                <div class="explanation-container" id="explanation-container">
                    <div class="explanation-title">ðŸ“ Code Explanation</div>
                    <div class="explanation-text" id="explanation-text"></div>
                </div>
                <div class="warnings-container" id="warnings-container">
                    <div class="warnings-title">âš ï¸ Warnings</div>
                    <div id="warnings-content"></div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Modal -->
        <div class="analysis-modal" id="analysis-modal">
            <div class="modal-content">
                <div class="modal-spinner"></div>
                <h4 data-i18n="analyzing">Analyzing...</h4>
                <p id="analysis-status"></p>
            </div>
        </div>

        <div class="tab-content" id="settings-tab">
            <div class="settings-container">
                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-icon">ðŸŒ</span>
                        <span class="settings-section-title">Language Settings</span>
                    </div>
                    <div class="settings-section-content">
                        <div class="form-group-compact">
                            <label for="language" class="label-compact">Display Language</label>
                            <select id="language-select" class="input-compact">
                                <option value="en" selected>English</option>
                                <option value="es">EspaÃ±ol</option>
                            </select>
                        </div>
                        <button id="save-language-btn" class="report-button" style="margin-top: 10px;">
                            <span class="button-icon">ðŸ’¾</span>
                            <span class="button-text">Save Language</span>
                        </button>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-icon">ðŸŽ¯</span>
                        <span class="settings-section-title">Diagram Layout</span>
                    </div>
                    <div class="settings-section-content">
                        <div class="form-group-compact">
                            <label for="layout-mode" class="label-compact">Layout Optimization</label>
                            <select id="layout-mode" class="input-compact">
                                <option value="ai" selected>AI-Optimized (Gemini)</option>
                                <option value="hierarchical">Hierarchical (Layered)</option>
                                <option value="auto">Automatic (D3 Force-Directed)</option>
                            </select>
                            <div class="help-text">
                                <strong>AI-Optimized:</strong> Gemini analyzes and optimizes the layout (requires API key)<br>
                                <strong>Hierarchical:</strong> Organized in layers, reduces crossings<br>
                                <strong>Automatic:</strong> Fast, physics-based layout
                            </div>
                        </div>
                        <button id="apply-layout-btn" class="report-button" style="margin-top: 10px;">
                            <span class="button-icon">âœ¨</span>
                            <span class="button-text">Apply Layout</span>
                        </button>
                        <div id="layout-status" class="connection-status"></div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-header">
                        <span class="settings-section-icon">ðŸ¤–</span>
                        <span class="settings-section-title">AI Configuration</span>
                    </div>
                    <div class="settings-section-content">
                        <!-- 1. API Key -->
                        <div class="form-group-compact">
                            <label for="api-key" class="label-compact">Gemini API Key</label>
                            <input type="password" id="api-key" class="input-compact input-api-key" placeholder="Enter your Gemini API Key">
                            <div class="help-text">
                                <a href="https://aistudio.google.com/app/apikey" target="_blank">Get your API key from Google AI Studio</a>
                            </div>
                        </div>
                        
                        <!-- 2. Model Selection -->
                        <div class="form-group-compact" style="margin-top: 12px;">
                            <label for="model" class="label-compact">Model</label>
                            <select id="model" class="input-compact">
                                <option value="gemini-3-flash-preview">Gemini 3 Flash (Lite) - Faster</option>
                                <option value="gemini-3-pro">Gemini 3 Pro - More Detailed</option>
                            </select>
                        </div>
                        
                        <!-- 3. Action Buttons -->
                        <div class="button-group-inline" style="margin-top: 12px;">
                            <button class="button-compact button-primary" id="save-api-key-btn">
                                <span class="button-icon">ðŸ’¾</span>
                                <span class="button-text">Save</span>
                            </button>
                            <button class="button-compact button-secondary" id="clear-api-key-btn">
                                <span class="button-icon">ðŸ—‘ï¸</span>
                                <span class="button-text">Clear</span>
                            </button>
                        </div>
                        
                        <!-- 4. Test Connection (Below) -->
                        <button class="button-compact button-test" id="test-connection-btn" style="margin-top: 12px;">
                            <span class="button-icon">ðŸ”Œ</span>
                            <span class="button-text">Test Connection</span>
                        </button>
                        <div id="connection-status" class="connection-status"></div>
                    </div>
                </div>

                <div id="status-message"></div>
            </div>
        </div>
        
        <div class="tab-content" id="security-tab">
            <div class="security-container">
                <div class="security-empty-state" id="security-empty-state">
                    <div class="empty-state-icon">ðŸ”’</div>
                    <div class="empty-state-title">No Security Analysis Available</div>
                    <div class="empty-state-message">
                        Analyze some files to see security and quality findings here.
                    </div>
                </div>
                
                <div class="security-content" id="security-content" style="display: none;">
                    <div class="security-summary" id="security-summary">
                        <div class="summary-header">
                            <h3 data-i18n="analysisSummary"></h3>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="total-findings">0</div>
                                <div class="stat-label" data-i18n="totalFindings">Total Findings</div>
                            </div>
                            <div class="stat-card stat-high">
                                <div class="stat-value" id="high-severity">0</div>
                                <div class="stat-label" data-i18n="highSeverity">High Severity</div>
                            </div>
                            <div class="stat-card stat-medium">
                                <div class="stat-value" id="medium-severity">0</div>
                                <div class="stat-label" data-i18n="mediumSeverity">Medium Severity</div>
                            </div>
                            <div class="stat-card stat-low">
                                <div class="stat-value" id="low-severity">0</div>
                                <div class="stat-label" data-i18n="lowSeverity">Low Severity</div>
                            </div>
                        </div>
                        <div class="risk-level-container">
                            <div class="risk-level-content">
                                <div class="risk-level-label" data-i18n="overallRiskLevel">Overall Risk Level:</div>
                                <div class="risk-level-badge" id="risk-level-badge" data-i18n="riskLow">Low</div>
                            </div>
                            <button class="risk-info-button" id="risk-info-btn" title="How is risk calculated?">?</button>
                            <button class="report-button" id="generate-security-report-btn" title="Generar Reporte">
                                ðŸ“„ Report
                            </button>
                        </div>
                        
                        <div class="ai-report-section" id="ai-report-section" style="display: none;">
                            <div class="ai-report-header">
                                <h4 data-i18n="aiExecutiveSummary">ðŸ¤– AI Executive Summary</h4>
                                <button class="button-regenerate" id="regenerate-btn">
                                    <span class="button-icon">ðŸ”„</span>
                                    <span class="button-text" data-i18n="regenerate">Regenerate</span>
                                </button>
                            </div>
                            <div class="ai-report-content" id="ai-report-content">
                                <div class="ai-report-loading" id="ai-report-loading">
                                    <div class="loading-spinner"></div>
                                    <div class="loading-text" data-i18n="generatingAISummary">Generating AI summary...</div>
                                </div>
                                <div class="ai-report-text" id="ai-report-text"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="security-findings" id="security-findings">
                        <div class="findings-header">
                            <h3 data-i18n="findings">ðŸ” Findings</h3>
                        </div>
                        <div id="findings-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="quality-tab">
            <div class="quality-container">
                <div class="quality-empty-state" id="quality-empty-state">
                    <div class="empty-state-icon">ðŸ”</div>
                    <h4>No hay anÃ¡lisis de calidad disponible</h4>
                    <p>Presiona el botÃ³n "Analizar Calidad" para comenzar</p>
                </div>

                <div class="quality-content" id="quality-content" style="display: none;">
                    <div class="quality-summary" id="quality-summary">
                        <div class="summary-header">
                            <h3>ðŸ“Š Resumen del AnÃ¡lisis</h3>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-card stat-info">
                                <div class="stat-value" id="quality-score">0</div>
                                <div class="stat-label">PuntuaciÃ³n de Calidad</div>
                            </div>
                            <div class="stat-card stat-warning">
                                <div class="stat-value" id="improvement-count">0</div>
                                <div class="stat-label">Oportunidades de Mejora</div>
                            </div>
                            <div class="stat-card stat-high">
                                <div class="stat-value" id="bug-count">0</div>
                                <div class="stat-label">Posibles Bugs</div>
                            </div>
                        </div>
                        <div class="risk-level-container">
                            <div class="risk-level-content">
                                <button class="button-recommendation" id="analyze-quality-btn">
                                    <span class="button-icon">ðŸ”</span>
                                    <span class="button-text">Analizar Calidad</span>
                                </button>
                            </div>
                            <button class="report-button" id="generate-quality-report-btn" title="Generate Quality Report" style="display: none;">
                                <span class="button-icon">ðŸ“„</span>
                                <span class="button-text">Report</span>
                            </button>
                        </div>
                    </div>

                    <div class="quality-findings">
                        <div class="findings-header">
                            <h3>ðŸ” Hallazgos</h3>
                        </div>
                        <div id="quality-findings-list">
                            <div class="quality-section">
                                <h4>ðŸ› Posibles Bugs</h4>
                                <div id="bugs-list" class="quality-list"></div>
                            </div>

                            <div class="quality-section">
                                <h4>ðŸ’¡ Oportunidades de Mejora</h4>
                                <div id="improvements-list" class="quality-list"></div>
                            </div>

                            <div class="quality-section">
                                <h4>âš¡ Optimizaciones de Rendimiento</h4>
                                <div id="performance-list" class="quality-list"></div>
                            </div>

                            <div class="quality-section">
                                <h4>ðŸ“ Mejores PrÃ¡cticas</h4>
                                <div id="best-practices-list" class="quality-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="node-popup" id="node-popup">
        <div class="node-popup-title" id="popup-title"></div>
        <div class="node-popup-description" id="popup-description"></div>
    </div>

    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="analyze-context-file">Analyze</div>
        <div class="context-menu-item" id="update-context-file">Update Analysis</div>
    </div>

    <div class="details-panel" id="details-panel">
        <div class="details-panel-resizer" id="details-panel-resizer"></div>
        <div class="details-panel-header">
            <div class="details-panel-title" id="details-panel-title">ðŸ“‹ File Analysis Details</div>
            <div class="details-panel-close" id="details-panel-close">âœ•</div>
        </div>
        <div class="details-panel-content" id="details-panel-content">
            <!-- Content will be populated dynamically -->
        </div>
    </div>

    <!-- Risk calculation info modal -->
    <div class="risk-info-modal" id="risk-info-modal">
        <div class="risk-info-content">
            <div class="risk-info-header">
                <h4>Risk Level Calculation</h4>
                <button class="risk-info-close" id="risk-info-close">X</button>
            </div>
            <div class="risk-info-body">
                <p><strong>How we calculate the overall risk level:</strong></p>
                
                <div class="risk-formula">
                    <div class="risk-formula-item">
                        <span class="severity-badge high">High</span>
                        <span class="formula-text">x 5 points</span>
                    </div>
                    <div class="risk-formula-item">
                        <span class="severity-badge medium">Medium</span>
                        <span class="formula-text">x 2 points</span>
                    </div>
                    <div class="risk-formula-item">
                        <span class="severity-badge low">Low</span>
                        <span class="formula-text">x 1 point</span>
                    </div>
                </div>
                
                <div class="risk-levels">
                    <div class="risk-level-item critical">
                        <strong>CRITICAL</strong>
                        <p>Any high severity finding OR score &gt;= 12</p>
                    </div>
                    <div class="risk-level-item high">
                        <strong>HIGH</strong>
                        <p>Score &gt;= 6 (e.g., 3 medium issues)</p>
                    </div>
                    <div class="risk-level-item medium">
                        <strong>MEDIUM</strong>
                        <p>Score &gt;= 3 (e.g., 1-2 medium issues)</p>
                    </div>
                    <div class="risk-level-item low">
                        <strong>LOW</strong>
                        <p>Score &lt; 3 (only low severity findings)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let diagramRenderer = null;
        let currentDiagramData = null;
        let currentLanguage = 'en';
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let draggedNode = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let fileVisibilityMap = new Map(); // Track which files are visible
        let currentFindings = []; // Store current findings for regeneration
        let analysisDataMap = new Map(); // Store analysis data for each file
        let savePositionsTimeout = null; // Timeout for debounced position saving
        
        // Debounce function
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(savePositionsTimeout);
                    func(...args);
                };
                clearTimeout(savePositionsTimeout);
                savePositionsTimeout = setTimeout(later, wait);
            };
        }
        
        // Debounced save positions function
        const debouncedSavePositions = debounce((positions) => {
            vscode.postMessage({
                command: 'saveNodePositions',
                positions: positions
            });
        }, 500); // Save after 500ms of no movement
        
        // Helper functions to avoid regex in code (causes issues in VS Code webviews)
        function sanitizeId(str) {
            return str.toLowerCase()
                .split('').map(c => /[a-z0-9]/.test(c) ? c : '_').join('')
                .split('_').filter(s => s).join('_');
        }
        
        function removeUnderscores(str) {
            return str.split('_').join('');
        }
        
        function escapeQuotes(str) {
            return str.split('"').join('\\\\"');
        }
        
        function replaceDoubleNewlines(str) {
            return str.split('\\n\\n').join('</p><p>');
        }
        
        function replaceSingleNewlines(str) {
            return str.split('\\n').join('<br>');
        }
        
        const translations = {
            en: {
                // Tabs
                language: 'Language / Idioma',
                diagram: 'Diagram',
                settings: 'Settings',
                security: 'Security Analysis',
                
                // Settings
                apiKey: 'Gemini API Key',
                save: 'Save',
                clear: 'Clear',
                enterApiKey: 'Enter your Gemini API Key',
                languageSettings: 'Language Settings',
                diagramType: 'Diagram Type',
                apiConfiguration: 'API Configuration',
                displayLanguage: 'Display Language',
                getApiKey: 'Get your API key from',
                
                // Messages
                analysisComplete: 'Analysis complete!',
                apiKeySaved: 'API Key saved successfully',
                apiKeyCleared: 'API Key cleared',
                
                // Diagram sections
                codeExplanation: 'Code Explanation',
                warnings: 'Warnings',
                
                // Warning types
                security: 'Security',
                logic: 'Logic',
                bestPractice: 'Best Practice',
                securityWarnings: 'Security Warnings',
                logicWarnings: 'Logic Warnings',
                bestPracticeSuggestions: 'Best Practice Suggestions',
                
                // Left menu
                analyzedFiles: 'Analyzed Files',
                
                // Export menu
                export: 'Export',
                exportAsPNG: 'Export as PNG',
                exportAsSVG: 'Export as SVG',
                exportAsMermaid: 'Export as Mermaid',
                exportAsJSON: 'Export as JSON',
                
                // Zoom controls
                zoomIn: 'Zoom In',
                zoomOut: 'Zoom Out',
                reset: 'Reset',
                
                // Context menu
                analyze: 'Analyze',
                updateAnalysis: 'Update Analysis',
                
                // Details panel
                fileAnalysisDetails: 'File Analysis Details',
                explanation: 'Explanation',
                dependencies: 'Dependencies',
                noAnalysisData: 'No analysis data available for this file.',
                noDetailedAnalysis: 'No detailed analysis available.',
                fromCache: 'From Cache',
                cachedAt: 'Cached at',
                clearCache: 'Clear Cache',
                cacheCleared: 'Analysis cache cleared',
                cacheError: 'Failed to load cache',
                confirmClearCache: 'Are you sure you want to clear the cache? This will remove all cached analyses.',
                never: 'Never',
                
                // Node popup
                noDescription: 'No description available',
                
                // Status messages
                analyzing: 'Analyzing file...',
                analysisFailed: 'Analysis failed',
                diagramCleared: 'Diagram and cache cleared successfully',
                exportSuccess: 'Diagram exported successfully',
                exportFailed: 'Failed to export diagram',
                
                // Errors
                error: 'Error',
                pleaseEnterApiKey: 'Please enter an API Key',
                apiKeyNotConfigured: 'API Key not configured. Please set your Gemini API Key in the Settings tab.',
                failedToNavigate: 'Failed to navigate',
                failedToAnalyze: 'Failed to analyze file',
                failedToUpdate: 'Failed to update analysis',
                failedToToggle: 'Failed to toggle file visibility',
                
                // API Key validation
                testConnection: 'Test Connection',
                testingConnection: 'Testing connection...',
                connectionSuccess: 'Connection successful! API Key is valid.',
                connectionFailed: 'Connection failed',
                
                // Model selection
                model: 'Model',
                modelFlash: 'Gemini 3 Flash (Lite) - Faster',
                modelPro: 'Gemini 3 Pro - More Detailed',
                modelSaved: 'Model preference saved',
                modelHelp: 'Flash is faster and cheaper, Pro provides more detailed analysis',
                
                // Security tab
                noSecurityAnalysis: 'No Security Analysis Available',
                analyzeFilesPrompt: 'Analyze some files to see security and quality findings here.',
                analysisSummary: 'Analysis Summary',
                totalFindings: 'Total Findings',
                highSeverity: 'High Severity',
                mediumSeverity: 'Medium Severity',
                lowSeverity: 'Low Severity',
                overallRiskLevel: 'Overall Risk Level:',
                findings: 'Findings',
                generateReport: 'Generate Report',
                riskCritical: 'Critical',
                riskHigh: 'High',
                riskMedium: 'Medium',
                riskLow: 'Low',
                securityType: 'Security',
                logicType: 'Logic',
                bestPracticeType: 'Best Practice',
                aiExecutiveSummary: 'AI Executive Summary',
                regenerate: 'Regenerate',
                generatingAISummary: 'Generating AI summary...',
                getRecommendation: 'Get Recommendation',
                recommendation: 'Recommendation',
                loadingRecommendation: 'Loading recommendation...',
                navigateToCode: 'Go to code'
            },
            es: {
                // Tabs
                language: 'Idioma / Language',
                diagram: 'Diagrama',
                settings: 'ConfiguraciÃ³n',
                security: 'AnÃ¡lisis de Seguridad',
                
                // Settings
                apiKey: 'Clave API de Gemini',
                save: 'Guardar',
                clear: 'Limpiar',
                enterApiKey: 'Ingrese su clave API de Gemini',
                languageSettings: 'ConfiguraciÃ³n de Idioma',
                diagramType: 'Tipo de Diagrama',
                apiConfiguration: 'ConfiguraciÃ³n de IA',
                displayLanguage: 'Idioma de VisualizaciÃ³n',
                getApiKey: 'Obtenga su clave API desde',
                
                // Messages
                analysisComplete: 'Â¡AnÃ¡lisis completado!',
                apiKeySaved: 'Clave API guardada exitosamente',
                apiKeyCleared: 'Clave API eliminada',
                
                // Diagram sections
                codeExplanation: 'ExplicaciÃ³n del CÃ³digo',
                warnings: 'Advertencias',
                
                // Warning types
                security: 'Seguridad',
                logic: 'LÃ³gica',
                bestPractice: 'Mejores PrÃ¡cticas',
                securityWarnings: 'Advertencias de Seguridad',
                logicWarnings: 'Advertencias de LÃ³gica',
                bestPracticeSuggestions: 'Sugerencias de Mejores PrÃ¡cticas',
                
                // Left menu
                analyzedFiles: 'Archivos Analizados',
                
                // Export menu
                export: '',
                exportAsPNG: 'Exportar como PNG',
                exportAsSVG: 'Exportar como SVG',
                exportAsMermaid: 'Exportar como Mermaid',
                exportAsJSON: 'Exportar como JSON',
                
                // Zoom controls
                zoomIn: 'Acercar',
                zoomOut: 'Alejar',
                reset: 'Restablecer',
                
                // Context menu
                analyze: 'Analizar',
                updateAnalysis: 'Actualizar AnÃ¡lisis',
                
                // Details panel
                fileAnalysisDetails: 'Detalles del AnÃ¡lisis del Archivo',
                explanation: 'ExplicaciÃ³n',
                dependencies: 'Dependencias',
                noAnalysisData: 'No hay datos de anÃ¡lisis disponibles para este archivo.',
                noDetailedAnalysis: 'No hay anÃ¡lisis detallado disponible.',
                fromCache: 'Desde CachÃ©',
                cachedAt: 'Almacenado en',
                clearCache: 'Limpiar CachÃ©',
                cacheCleared: 'CachÃ© de anÃ¡lisis limpiado',
                cacheError: 'Error al cargar cachÃ©',
                confirmClearCache: 'Â¿EstÃ¡ seguro de que desea limpiar el cachÃ©? Esto eliminarÃ¡ todos los anÃ¡lisis almacenados.',
                never: 'Nunca',
                
                // Node popup
                noDescription: 'No hay descripciÃ³n disponible',
                
                // Status messages
                analyzing: 'Analizando archivo...',
                analysisFailed: 'AnÃ¡lisis fallido',
                diagramCleared: 'Diagrama y cachÃ© limpiados exitosamente',
                exportSuccess: 'Diagrama exportado exitosamente',
                exportFailed: 'Error al exportar diagrama',
                
                // Errors
                error: 'Error',
                pleaseEnterApiKey: 'Por favor ingrese una clave API',
                apiKeyNotConfigured: 'Clave API no configurada. Por favor configure su clave API de Gemini en la pestaÃ±a de ConfiguraciÃ³n.',
                failedToNavigate: 'Error al navegar',
                failedToAnalyze: 'Error al analizar archivo',
                failedToUpdate: 'Error al actualizar anÃ¡lisis',
                failedToToggle: 'Error al cambiar visibilidad del archivo',
                
                // API Key validation
                testConnection: 'Probar ConexiÃ³n',
                testingConnection: 'Probando conexiÃ³n...',
                connectionSuccess: 'Â¡ConexiÃ³n exitosa! La clave API es vÃ¡lida.',
                connectionFailed: 'ConexiÃ³n fallida',
                
                // Model selection
                model: 'Modelo',
                modelFlash: 'Gemini 3 Flash (Lite) - MÃ¡s RÃ¡pido',
                modelPro: 'Gemini 3 Pro - MÃ¡s Detallado',
                modelSaved: 'Preferencia de modelo guardada',
                modelHelp: 'Flash es mÃ¡s rÃ¡pido y econÃ³mico, Pro proporciona anÃ¡lisis mÃ¡s detallado',
                
                // Security tab
                noSecurityAnalysis: 'No Hay AnÃ¡lisis de Seguridad Disponible',
                analyzeFilesPrompt: 'Analice algunos archivos para ver hallazgos de seguridad y calidad aquÃ­.',
                analysisSummary: 'Resumen del AnÃ¡lisis',
                totalFindings: 'Hallazgos Totales',
                highSeverity: 'Severidad Alta',
                mediumSeverity: 'Severidad Media',
                lowSeverity: 'Severidad Baja',
                overallRiskLevel: 'Nivel de Riesgo General:',
                findings: 'Hallazgos',
                generateReport: 'Generar Reporte',
                riskCritical: 'CrÃ­tico',
                riskHigh: 'Alto',
                riskMedium: 'Medio',
                riskLow: 'Bajo',
                securityType: 'Seguridad',
                logicType: 'LÃ³gica',
                bestPracticeType: 'Mejores PrÃ¡cticas',
                aiExecutiveSummary: 'Resumen Ejecutivo IA',
                regenerate: 'Regenerar',
                generatingAISummary: 'Generando resumen con IA...',
                getRecommendation: 'Obtener RecomendaciÃ³n',
                recommendation: 'RecomendaciÃ³n',
                loadingRecommendation: 'Cargando recomendaciÃ³n...',
                navigateToCode: 'Ir al cÃ³digo'
            }
        };
        
        function t(key) {
            return translations[currentLanguage][key] || translations['en'][key];
        }
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('codeArchitectLanguage', lang);
            // Notify backend about language change
            vscode.postMessage({ command: 'changeLanguage', language: lang });
            updateUILanguage();
        }
        
        function updateUILanguage() {
            // Update tabs
            const diagramTab = document.querySelector('[data-tab="diagram"]');
            const settingsTab = document.querySelector('[data-tab="settings"]');
            const securityTab = document.querySelector('[data-tab="security"]');
            if (diagramTab) diagramTab.textContent = t('diagram');
            if (settingsTab) settingsTab.textContent = t('settings');
            if (securityTab) securityTab.textContent = t('security');
            
            // Update settings section titles
            const settingsTabContent = document.getElementById('settings-tab');
            if (settingsTabContent) {
                const settingsSectionTitles = settingsTabContent.querySelectorAll('.settings-section-title');
                console.log('Found settings section titles:', settingsSectionTitles.length);
                console.log('Translation for aiConfiguration:', t('aiConfiguration'));
                console.log('Translation for languageSettings:', t('languageSettings'));
                console.log('Translation for diagramType:', t('diagramType'));
                
                if (settingsSectionTitles.length >= 1) settingsSectionTitles[0].textContent = t('languageSettings');
                if (settingsSectionTitles.length >= 2) settingsSectionTitles[1].textContent = t('diagramType');
                if (settingsSectionTitles.length >= 3) settingsSectionTitles[2].textContent = t('aiConfiguration');
                
                console.log('Updated titles:');
                for (let i = 0; i < settingsSectionTitles.length; i++) {
                    console.log('  Title ' + i + ': "' + settingsSectionTitles[i].textContent + '"');
                }
            } else {
                console.error('Settings tab not found!');
            }
            
            // Update settings labels
            const displayLanguageLabel = document.querySelector('label[for="language"]');
            const apiKeyLabel = document.querySelector('label[for="api-key"]');
            if (displayLanguageLabel) displayLanguageLabel.textContent = t('displayLanguage');
            if (apiKeyLabel) apiKeyLabel.textContent = t('apiKey');
            
            // Update button text (only the text, keep icons)
            const buttonTexts = document.querySelectorAll('.button-text');
            if (buttonTexts.length >= 2) {
                buttonTexts[0].textContent = t('save');
                buttonTexts[1].textContent = t('clear');
            }
            
            // Update Test Connection button
            const testConnectionBtn = document.getElementById('test-connection-btn');
            if (testConnectionBtn) {
                const testBtnText = testConnectionBtn.querySelector('.button-text');
                if (testBtnText) testBtnText.textContent = t('testConnection');
            }
            
            // Update input placeholders
            const apiKeyInput = document.getElementById('api-key');
            if (apiKeyInput) apiKeyInput.placeholder = t('enterApiKey');
            
            // Update model selector
            const modelLabel = document.querySelector('label[for="model"]');
            if (modelLabel) modelLabel.textContent = t('model');
            
            const modelSelect = document.getElementById('model');
            if (modelSelect) {
                const options = modelSelect.querySelectorAll('option');
                if (options.length >= 2) {
                    options[0].textContent = t('modelFlash');
                    options[1].textContent = t('modelPro');
                }
            }
            
            // Update help texts
            const helpTexts = document.querySelectorAll('.help-text');
            if (helpTexts.length >= 1) {
                helpTexts[0].innerHTML = '<a href="https://aistudio.google.com/app/apikey" target="_blank">' + t('getApiKey') + '</a>';
            }
            if (helpTexts.length >= 2) {
                helpTexts[1].textContent = t('modelHelp');
            }
            
            // Update left menu title
            const leftMenuTitle = document.querySelector('.left-menu-title');
            if (leftMenuTitle) leftMenuTitle.textContent = t('analyzedFiles');
            
            // Update export button
            const exportButton = document.querySelector('.export-button');
            if (exportButton) exportButton.innerHTML = 'ðŸ“¤ ' + t('export');
            
            // Update export menu items
            const exportMenuItems = document.querySelectorAll('.export-menu-item');
            if (exportMenuItems.length >= 4) {
                exportMenuItems[0].innerHTML = '<span class="export-menu-item-icon">ðŸ–¼ï¸</span>' + t('exportAsPNG');
                exportMenuItems[1].innerHTML = '<span class="export-menu-item-icon">ðŸ“</span>' + t('exportAsSVG');
                exportMenuItems[2].innerHTML = '<span class="export-menu-item-icon">ðŸ“Š</span>' + t('exportAsMermaid');
                exportMenuItems[3].innerHTML = '<span class="export-menu-item-icon">ðŸ“„</span>' + t('exportAsJSON');
            }
            
            // Update zoom button titles
            const zoomButtons = document.querySelectorAll('.zoom-button');
            if (zoomButtons.length >= 3) {
                zoomButtons[0].title = t('zoomIn');
                zoomButtons[1].title = t('zoomOut');
                zoomButtons[2].title = t('reset');
            }
            
            // Update context menu
            const contextMenuItems = document.querySelectorAll('.context-menu-item');
            if (contextMenuItems.length >= 2) {
                contextMenuItems[0].textContent = t('analyze');
                contextMenuItems[1].textContent = t('updateAnalysis');
            }
            
            // Update explanation and warnings titles
            const explanationTitle = document.querySelector('.explanation-title');
            const warningsTitle = document.querySelector('.warnings-title');
            if (explanationTitle) explanationTitle.textContent = 'ðŸ“ ' + t('codeExplanation');
            if (warningsTitle) warningsTitle.textContent = 'âš ï¸ ' + t('warnings');
            
            // Update security tab
            const emptyStateTitle = document.querySelector('.empty-state-title');
            const emptyStateMessage = document.querySelector('.empty-state-message');
            if (emptyStateTitle) emptyStateTitle.textContent = t('noSecurityAnalysis');
            if (emptyStateMessage) emptyStateMessage.textContent = t('analyzeFilesPrompt');
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    // Preserve emojis and icons at the start
                    const currentText = element.textContent || '';
                    const emojiMatch = currentText.match(/^([\u{1F300}-\u{1F9FF}][\u{FE00}-\u{FE0F}]?|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}])\s*/u);
                    const emoji = emojiMatch ? emojiMatch[0] : '';
                    element.textContent = emoji + t(key);
                }
            });
            
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels.length >= 4) {
                statLabels[0].textContent = t('totalFindings');
                statLabels[1].textContent = t('highSeverity');
                statLabels[2].textContent = t('mediumSeverity');
                statLabels[3].textContent = t('lowSeverity');
            }
            
            const riskLevelLabel = document.querySelector('.risk-level-label');
            if (riskLevelLabel) riskLevelLabel.textContent = t('overallRiskLevel');
            
            // Update analysis summary title with emoji
            const analysisSummaryTitle = document.querySelector('.summary-header h3[data-i18n="analysisSummary"]');
            if (analysisSummaryTitle) analysisSummaryTitle.textContent = 'ðŸ“Š ' + t('analysisSummary');
            
            // Update quality report button
            const generateQualityReportBtn = document.querySelector('#generate-quality-report-btn .button-text');
            if (generateQualityReportBtn) generateQualityReportBtn.textContent = 'Report';
            
            // Update AI report section
            const aiReportHeaders = document.querySelectorAll('.ai-report-header h4');
            if (aiReportHeaders.length > 0) aiReportHeaders[0].textContent = 'ðŸ¤– ' + t('aiExecutiveSummary');
            
            const regenerateBtnText = document.querySelector('.button-regenerate .button-text');
            if (regenerateBtnText) regenerateBtnText.textContent = t('regenerate');
            
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = t('generatingAISummary');
        }
        
        // Load saved language
        const savedLanguage = localStorage.getItem('codeArchitectLanguage');
        console.log('[Webview] Saved language from localStorage:', savedLanguage);
        if (savedLanguage) {
            currentLanguage = savedLanguage;
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) {
                languageSelect.value = savedLanguage;
            }
            console.log('[Webview] Current language set to:', currentLanguage);
        } else {
            console.log('[Webview] No saved language, using default:', currentLanguage);
        }
        
        // Add event listener for save language button
        const saveLanguageBtn = document.getElementById('save-language-btn');
        if (saveLanguageBtn) {
            saveLanguageBtn.addEventListener('click', () => {
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    const selectedLanguage = languageSelect.value;
                    changeLanguage(selectedLanguage);
                }
            });
        }

        // Add event listener for apply layout button
        const applyLayoutBtn = document.getElementById('apply-layout-btn');
        if (applyLayoutBtn) {
            applyLayoutBtn.addEventListener('click', () => {
                const layoutMode = document.getElementById('layout-mode');
                const layoutStatus = document.getElementById('layout-status');
                
                if (layoutMode) {
                    const selectedMode = layoutMode.value;
                    
                    // Show loading state
                    layoutStatus.textContent = 'Applying layout...';
                    layoutStatus.className = 'connection-status visible loading';
                    applyLayoutBtn.disabled = true;
                    
                    // Send message to extension
                    vscode.postMessage({ 
                        command: 'applyLayout', 
                        mode: selectedMode 
                    });
                }
            });
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                switchTab(tab);
            });
        });

        function switchTab(tab) {
            console.log('[Webview] switchTab called with:', tab);
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabButton = document.querySelector(\`[data-tab="\${tab}"]\`);
            const tabContent = document.getElementById(\`\${tab}-tab\`);
            
            console.log('[Webview] Tab button found:', tabButton);
            console.log('[Webview] Tab content found:', tabContent);
            
            if (tabButton) {
                tabButton.classList.add('active');
            }
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // Update language when switching to settings tab
            if (tab === 'settings') {
                updateUILanguage();
            }
            
            vscode.postMessage({ command: 'switchTab', tab: tab });
        }

        function saveAPIKey() {
            const apiKey = document.getElementById('api-key').value;
            if (!apiKey) {
                showStatusMessage(t('pleaseEnterApiKey'), 'error');
                return;
            }
            vscode.postMessage({ command: 'saveAPIKey', apiKey: apiKey });
        }

        function clearAPIKey() {
            vscode.postMessage({ command: 'clearAPIKey' });
            document.getElementById('api-key').value = '';
        }

        function testConnection() {
            const apiKey = document.getElementById('api-key').value;
            const statusDiv = document.getElementById('connection-status');
            const testBtn = document.getElementById('test-connection-btn');
            
            if (!apiKey) {
                statusDiv.textContent = t('pleaseEnterApiKey');
                statusDiv.className = 'connection-status visible error';
                return;
            }
            
            // Show loading state
            statusDiv.textContent = t('testingConnection');
            statusDiv.className = 'connection-status visible loading';
            testBtn.disabled = true;
            
            // Send message to extension to validate API key
            vscode.postMessage({ command: 'validateAPIKey', apiKey: apiKey });
        }

        function saveModel(model) {
            vscode.postMessage({ command: 'saveModel', model: model });
            showStatusMessage(t('modelSaved'), 'success');
        }

        function showDiagramLoader() {
            const loader = document.getElementById('diagram-loading');
            if (loader) {
                loader.classList.add('visible');
            }
        }

        function hideDiagramLoader() {
            const loader = document.getElementById('diagram-loading');
            if (loader) {
                loader.classList.remove('visible');
            }
        }

        function showAnalysisModal(fileName) {
            const modal = document.getElementById('analysis-modal');
            const status = document.getElementById('analysis-status');
            if (modal && status) {
                status.textContent = fileName ? \`Analyzing \${fileName}\` : 'Analyzing...';
                modal.classList.add('visible');
            }
        }

        function hideAnalysisModal() {
            const modal = document.getElementById('analysis-modal');
            if (modal) {
                modal.classList.remove('visible');
            }
        }

        function generateSecurityReport() {
            // Generate HTML report
            vscode.postMessage({ command: 'generateHTMLReport' });
        }

        function analyzeCodeQuality() {
            console.log('[Webview] Analyzing code quality...');
            
            const analyzeQualityBtn = document.getElementById('analyze-quality-btn');
            if (analyzeQualityBtn) {
                analyzeQualityBtn.disabled = true;
                analyzeQualityBtn.innerHTML = '<span class="button-icon">â³</span><span class="button-text">Analizando...</span>';
            }
            
            // Request quality analysis from backend
            vscode.postMessage({ 
                command: 'analyzeCodeQuality'
            });
        }

        function regenerateAIReport() {
            // Get current findings from the summary
            const findingsList = document.getElementById('findings-list');
            if (!findingsList || findingsList.children.length === 0) {
                console.warn('[Webview] No findings available to regenerate report');
                return;
            }
            
            // Show loading state
            displayAIReport('loading');
            
            // Send message with current findings
            vscode.postMessage({ 
                command: 'regenerateAIReport',
                findings: currentFindings || []
            });
        }

        function displayAIReport(report) {
            const aiReportSection = document.getElementById('ai-report-section');
            const aiReportLoading = document.getElementById('ai-report-loading');
            const aiReportText = document.getElementById('ai-report-text');
            const regenerateBtn = document.getElementById('regenerate-btn');

            // Show section
            aiReportSection.style.display = 'block';

            if (report === 'loading') {
                // Show loading state
                aiReportLoading.style.display = 'flex';
                aiReportText.style.display = 'none';
                regenerateBtn.disabled = true;
            } else {
                // Show report
                aiReportLoading.style.display = 'none';
                aiReportText.style.display = 'block';
                aiReportText.textContent = report;
                regenerateBtn.disabled = false;
            }
        }

        function updateSecurityUI(summary) {
            console.log('[Webview] updateSecurityUI called with:', summary);
            
            const emptyState = document.getElementById('security-empty-state');
            const content = document.getElementById('security-content');
            
            if (!summary || summary.totalFindings === 0) {
                console.log('[Webview] No security findings, showing empty state');
                if (emptyState) emptyState.style.display = 'flex';
                if (content) content.style.display = 'none';
                return;
            }

            console.log('[Webview] Displaying', summary.totalFindings, 'security findings');
            
            // Hide empty state, show content
            if (emptyState) emptyState.style.display = 'none';
            if (content) content.style.display = 'flex';

            // Store findings for regeneration
            currentFindings = summary.findings || [];

            // Update statistics
            document.getElementById('total-findings').textContent = summary.totalFindings;
            document.getElementById('high-severity').textContent = summary.highSeverity;
            document.getElementById('medium-severity').textContent = summary.mediumSeverity;
            document.getElementById('low-severity').textContent = summary.lowSeverity;

            // Update risk level badge
            const riskBadge = document.getElementById('risk-level-badge');
            riskBadge.textContent = t('risk' + summary.riskLevel.charAt(0).toUpperCase() + summary.riskLevel.slice(1));
            riskBadge.className = 'risk-level-badge ' + summary.riskLevel;

            // Update findings list with grouped display
            const findingsList = document.getElementById('findings-list');
            
            if (findingsList) {
                findingsList.innerHTML = '';

                // Use grouped findings if available, otherwise fall back to flat list
                if (summary.groupedFindings && Object.keys(summary.groupedFindings).length > 0) {
                    // Display grouped by file with accordion
                    Object.keys(summary.groupedFindings).forEach(file => {
                        const fileGroup = summary.groupedFindings[file];
                        
                        // Extract filename for display
                        const pathParts = file.split('/');
                        const pathParts2 = pathParts[pathParts.length - 1].split('\\\\');
                        const fileName = pathParts2[pathParts2.length - 1] || file;
                        
                        // Count total findings for this file
                        const totalFileFindings = (fileGroup.security?.length || 0) + 
                                                 (fileGroup.logic?.length || 0) + 
                                                 (fileGroup.bestPractice?.length || 0);
                        
                        // Create file header (accordion button)
                        const fileHeader = document.createElement('div');
                        fileHeader.className = 'findings-file-header';
                        fileHeader.innerHTML = '<h4><span class="accordion-icon">â–¶</span>ðŸ“„ ' + fileName + ' (' + totalFileFindings + ')</h4>';
                        
                        // Create content container
                        const fileContent = document.createElement('div');
                        fileContent.className = 'findings-file-content';
                        
                        // Display findings by type within this file
                        ['security', 'logic', 'bestPractice'].forEach(type => {
                            const typedFindings = fileGroup[type] || [];
                            
                            if (typedFindings.length > 0) {
                                // Create type subheader
                                const typeHeader = document.createElement('div');
                                typeHeader.className = 'findings-type-header';
                                const typeLabel = type === 'security' ? 'ðŸ” Security' : 
                                                type === 'logic' ? 'âš ï¸ Logic' : 
                                                'âœ¨ Best Practices';
                                typeHeader.innerHTML = '<h5>' + typeLabel + ' (' + typedFindings.length + ')</h5>';
                                fileContent.appendChild(typeHeader);
                                
                                // Display findings of this type
                                typedFindings.forEach(finding => {
                                    const findingCard = createFindingCard(finding);
                                    fileContent.appendChild(findingCard);
                                });
                            }
                        });
                        
                        // Add click handler for accordion
                        fileHeader.onclick = () => {
                            fileHeader.classList.toggle('collapsed');
                            fileContent.classList.toggle('collapsed');
                        };
                        
                        findingsList.appendChild(fileHeader);
                        findingsList.appendChild(fileContent);
                    });
                } else {
                    // Fallback: display flat list
                    summary.findings.forEach(finding => {
                        const findingCard = createFindingCard(finding);
                        findingsList.appendChild(findingCard);
                    });
                }
            }
        }

        function createFindingCard(finding) {
            const findingCard = document.createElement('div');
            findingCard.className = 'finding-item ' + finding.severity;

            const findingHeader = document.createElement('div');
            findingHeader.className = 'finding-header';

            const severityBadge = document.createElement('span');
            severityBadge.className = 'finding-severity ' + finding.severity;
            severityBadge.textContent = finding.severity.toUpperCase();

            findingHeader.appendChild(severityBadge);

            const findingMessage = document.createElement('div');
            findingMessage.className = 'finding-message';
            findingMessage.textContent = finding.message;

            const findingFile = document.createElement('div');
            findingFile.className = 'finding-file';
            
            // Extract just the filename from the path
            const fullPath = finding.file + (finding.line ? ':' + finding.line : '');
            const pathParts = finding.file.split('/');
            const pathParts2 = pathParts[pathParts.length - 1].split('\\\\');
            const fileName = pathParts2[pathParts2.length - 1] || finding.file;
            const displayText = (finding.line ? 'Line ' + finding.line : 'File');
            
            findingFile.textContent = displayText;
            findingFile.title = fullPath;

            // Add recommendation button and panel
            const findingActions = document.createElement('div');
            findingActions.className = 'finding-actions';

            // Add navigation button
            const navigateBtn = document.createElement('button');
            navigateBtn.className = 'navigate-to-code-btn';
            navigateBtn.innerHTML = 'ðŸ“ ' + t('navigateToCode');
            navigateBtn.title = t('navigateToCode');
            navigateBtn.onclick = () => {
                vscode.postMessage({
                    command: 'navigateToCode',
                    file: finding.file,
                    line: finding.line
                });
            };

            const recommendationBtn = document.createElement('button');
            recommendationBtn.className = 'button-recommendation';
            recommendationBtn.innerHTML = 'ðŸ’¡ ' + t('getRecommendation');
            
            const recommendationPanel = document.createElement('div');
            recommendationPanel.className = 'recommendation-panel';
            
            recommendationBtn.onclick = () => requestRecommendation(finding, recommendationBtn, recommendationPanel);

            findingActions.appendChild(navigateBtn);
            findingActions.appendChild(recommendationBtn);

            findingCard.appendChild(findingHeader);
            findingCard.appendChild(findingMessage);
            findingCard.appendChild(findingFile);
            findingCard.appendChild(findingActions);
            findingCard.appendChild(recommendationPanel);

            return findingCard;
        }

        function requestRecommendation(finding, button, panel) {
            // Show loading state
            panel.className = 'recommendation-panel visible';
            panel.innerHTML = '<div class="recommendation-loading"><div class="loading-spinner"></div>' + t('loadingRecommendation') + '</div>';
            button.disabled = true;

            // Request recommendation from backend
            vscode.postMessage({ 
                command: 'getRecommendation', 
                finding: finding,
                panelId: finding.file + '-' + finding.line
            });
        }

        function displayRecommendation(recommendation, panelId) {
            // Find all recommendation panels and update the matching one
            const panels = document.querySelectorAll('.recommendation-panel');
            panels.forEach(panel => {
                const card = panel.closest('.finding-item');
                if (card) {
                    const fileDiv = card.querySelector('.finding-file');
                    if (fileDiv && fileDiv.textContent.includes(panelId.split('-')[0])) {
                        panel.innerHTML = '<div class="recommendation-text">' + recommendation + '</div>';
                        const button = card.querySelector('.button-recommendation');
                        if (button) button.disabled = false;
                    }
                }
            });
        }

        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = '';
            const messageEl = document.createElement('div');
            messageEl.className = \`\${type}-message\